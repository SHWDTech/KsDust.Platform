@{
    Layout = null;
}
<div class="modal fade" id="usrModal" tabindex="-1" role="dialog" aria-labelledby="usrModallabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="usrModallabel">更新用户信息</h4>
            </div>
            <div class="modal-body">

            </div>
        </div>
    </div>
</div>
<div>
    <div style="margin-bottom: 5px;">
        <input type="button" class="btn btn-primary" value="新增登陆用户" onclick="addUser()" />
    </div>
    @(Html.BootstrapTable("users", "/Setting/UserTable", TablePaginationOption.server, new
{
    data_page_size = 25
})
          .Column("用户名", "UserName")
          .Column("用户所属角色", "UserRole")
          .Column("联系电话", "PhoneNumber")
          .Column("操作")
          .Apply(ColumnOption.formatter, "userOperaterFormatter")
          .Apply(ColumnOption.events, "userOerateEvents"))
</div>

<script type="text/javascript">
    $('#users').bootstrapTable({
        height: $('#users').parents('.tab-content').height() - 75
    });
    $('#usrModal').on('shown.bs.modal', function () {
        $.fn.modal.Constructor.prototype.enforceFocus = function () { };
        $('#UserRole').select2();
        var $ureSelect2 = $('#ure').find('select').select2();
        $('#UserRole').on('change', function (e) {
            $.get('/Ajax/RoleEntity', { roleId: e.target.value }, function (ret) {
                if (ret.hasEntitys) {
                    $('#ure').show();
                    $('#ure').find('label').html(ret.labelContent);
                } else {
                    $('#ure').hide();
                }
                $('#ure').find('select').empty();
                $ureSelect2 = $('#ure').find('select').select2({
                    data: ret.entities
                });
                if ($('#ureVal').length > 0) {
                    $ureSelect2.val($('#ureVal').val()).trigger("change");
                    $('#ureVal').remove();
                }
            });
        });
        $('#UserRole').change();
    });
    window.userOperaterFormatter = function () {
        return [
            '<a class="update" href="javascript:void(0)" title="更新用户信息">更新</a>',
            '<a class="delete" href="javascript:void(0)" title="删除用户" style="margin-left: 10px;">删除</a>',
            '<a class="password" href="javascript:void(0)" title="修改密码" style="margin-left: 10px;">修改密码</a>'
        ].join('');
    }

    var addUser = function () {
        $.get('/Setting/AddNewUser', null, function (ret) {
            $('#usrModal .modal-body').html(ret);
            $('#usrModal').modal();
        });
    };

    window.userOerateEvents = {
        'click .update': function (e, value, row) {
            $.get('/Setting/UpdateUser', { id: row.Id }, function (ret) {
                $('#usrModal .modal-body').html(ret);
                $('#usrModal').modal('show');
            });
        },
        'click .delete': function (e, value, row) {
            if (confirm("确定要删除用户：" + row.UserName + "吗？")) {
                $.get('/Setting/DeleteUser', { id: row.Id }, function (ret) {
                    $('#usrModal .modal-body').html(ret.message);
                    $('#usrModal').modal();
                });
            }
        },
        'click .password': function (e, value, row) {
            $.get('/Setting/UserPassword', { id: row.Id, name: row.UserName }, function (ret) {
                $('#usrModal .modal-body').html(ret);
                $('#usrModal').modal();
            });
        }
    };

    $('#usrModal').on('hidden.bs.modal', function () {
        $('#users').bootstrapTable('refresh',
            {
                url: '/Setting/UserTable'
            });
    });
</script>
